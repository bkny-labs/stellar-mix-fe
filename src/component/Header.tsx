import React, { useEffect, useState } from 'react';
import { UserProfile } from '../types';
import Spotlight from './Spotlight';
import { Link } from 'react-router-dom';
import { RiMenu4Fill } from "react-icons/ri";


interface HeaderProps {
  userProfile: UserProfile;
  toggleFilters: () => void;
  updateMoodData: (data: any) => void;
  onNavClick: () => void;
}

const Header: React.FC<HeaderProps> = ({ userProfile, toggleFilters, updateMoodData, onNavClick }) => {
  const [isSpotlightOpen, setIsSpotlightOpen] = useState(false);
  const [locked, setLocked] = useState(false);
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  const isLoggedIn = localStorage.getItem('isLoggedIn');

  const toggleSpotlight = () => {
    setIsSpotlightOpen(prevState => !prevState);
  };

  const handleKeyDown = (event: KeyboardEvent) => {
    const activeElement = document.activeElement;
    if (activeElement && activeElement.tagName === 'INPUT') {
      return;
    }

    if ((event.metaKey || event.ctrlKey) && event.key === 'k') {
      event.preventDefault();
      toggleSpotlight();
    } else if (event.key === 'Escape' && isSpotlightOpen) {
      setIsSpotlightOpen(false);
    }
  };

  useEffect(() => {
    const handleResize = () => {
      setIsMobile(window.innerWidth < 768);
    };

    window.addEventListener('resize', handleResize);
    return () => {
      window.removeEventListener('resize', handleResize);
    };
  }, []);

  useEffect(() => {
    window.addEventListener('keydown', handleKeyDown);
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
    };
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    const spotifyPlaylists = JSON.parse(localStorage.getItem('spotifyPlaylists') || '[]');
    if (spotifyPlaylists.length === 0) {
      setIsSpotlightOpen(true);
      setLocked(true);
    } else {
      setLocked(false);
    }
  }, []);

  return (
    <>
      <Spotlight isOpen={isSpotlightOpen} toggleSpotlight={toggleSpotlight} updateMoodData={updateMoodData} locked={locked} setLocked={setLocked} />
      <div className='header'>
        <div className="logo">
          {
            isMobile && isLoggedIn &&
            <RiMenu4Fill onClick={onNavClick} />
          }
          <Link to="/">
          <svg width="150px" height="663" viewBox="0 0 3296 663" fill="none" xmlns="http://www.w3.org/2000/svg">
            <mask id="mask0_220_121" maskUnits="userSpaceOnUse" x="0" y="-206" width="3465" height="1087">
            <path d="M3464.35 -206H0V880.476H3464.35V-206Z" fill="white"/>
            </mask>
            <g mask="url(#mask0_220_121)">
            <path d="M616.596 354.466C631.048 354.466 642.778 362.413 642.778 374.335V414.073V493.548V533.286C642.778 543.22 631.048 553.155 616.596 553.155H590.413V513.417V394.204V354.466H616.596Z" fill="var(--dark-highlight)"/>
            <path d="M616.596 553.156C631.048 553.156 642.778 543.221 642.778 533.287V493.549V453.812H590.413V513.418V553.156H616.596Z" fill="white"/>
            <path d="M302.404 354.466C287.943 354.466 276.222 362.413 276.222 374.335V414.073V493.548V533.286C276.222 543.22 287.943 553.155 302.404 553.155H328.587V513.417V394.204V354.466H302.404Z" fill="var(--dark-highlight)"/>
            <path d="M197.674 274.99V316.715C182.321 320.688 171.491 330.623 171.491 344.531C171.491 360.427 189.076 374.336 210.765 374.336H212.402L276.222 457.784V404.139L243.494 360.425C247.728 356.452 250.039 350.493 250.039 344.531C250.039 330.623 239.21 320.688 223.857 316.715V274.99H197.674Z" fill="black"/>
            <path d="M328.587 334.598V374.335V533.286V573.024H354.77H367.861C389.55 573.024 407.135 559.116 407.135 543.221V503.483V493.548V453.81V414.072V404.139V364.401C407.135 346.518 389.55 334.598 367.861 334.598H354.77H328.587Z" fill="black"/>
            <path d="M328.789 572.715V532.977V453.501H407.337V493.239V503.174V542.911C407.337 558.807 389.752 572.715 368.063 572.715H354.972H328.789Z" fill="var(--dark-highlight)"/>
            <path d="M354.77 334.598H302.404V573.024H354.77V334.598Z" fill="white"/>
            <path d="M590.413 334.598V374.335V533.286V573.024H564.231H551.139C529.46 573.024 511.865 559.116 511.865 543.221V503.483V493.548V453.81V414.072V404.139V364.401C511.865 346.518 529.46 334.598 551.139 334.598H564.231H590.413Z" fill="black"/>
            <path d="M590.413 573.025V533.287V453.812H511.865V493.549V503.484V543.221C511.865 559.117 529.46 573.025 551.139 573.025H564.231H590.413Z" fill="var(--dark-highlight)"/>
            <path d="M564.231 334.598H616.596V573.024H564.231V334.598Z" fill="white"/>
            <path d="M302.404 553.156C287.943 553.156 276.222 543.221 276.222 533.287V493.549V453.812H328.587V513.418V553.156H302.404Z" fill="white"/>
            <path d="M354.77 453.812H302.404V573.025H354.77V453.812Z" fill="white"/>
            <path d="M616.596 453.812H564.23V573.025H616.596V453.812Z" fill="white"/>
            <path d="M721.326 274.99V316.715C736.669 320.688 747.509 330.623 747.509 344.531C747.509 360.427 729.913 374.336 708.235 374.336H706.611L642.778 457.784V404.139L675.506 360.425C671.265 356.452 668.961 350.493 668.961 344.531C668.961 330.623 679.801 320.688 695.143 316.715V274.99H721.326Z" fill="black"/>
            <path d="M223.857 344.531C223.857 347.166 222.478 349.694 220.022 351.557C217.567 353.42 214.237 354.466 210.765 354.466C207.294 354.466 203.963 353.42 201.509 351.557C199.054 349.694 197.674 347.166 197.674 344.531C197.674 341.897 199.054 339.37 201.509 337.507C203.963 335.644 207.294 334.598 210.765 334.598C214.237 334.598 217.567 335.644 220.022 337.507C222.478 339.37 223.857 341.897 223.857 344.531Z" fill="var(--primary)"/>
            <path d="M721.326 344.531C721.326 347.166 719.946 349.694 717.492 351.557C715.037 353.42 711.707 354.466 708.235 354.466C704.763 354.466 701.433 353.42 698.978 351.557C696.523 349.694 695.144 347.166 695.144 344.531C695.144 341.897 696.523 339.37 698.978 337.507C701.433 335.644 704.763 334.598 708.235 334.598C711.707 334.598 715.037 335.644 717.492 337.507C719.946 339.37 721.326 341.897 721.326 344.531Z" fill="var(--primary)"/>
            <path d="M433.362 68.0612C334.961 65.5381 238.697 141.232 192.894 254.771C183.766 292.619 230.196 310.278 240.518 274.955C279.64 186.646 356.19 131.139 433.362 131.139H483.329C560.504 131.139 637.053 186.646 676.179 274.955C686.497 310.278 732.916 292.619 723.797 254.771C678.002 141.232 581.74 65.5381 483.329 68.0612H433.362Z" fill="black"/>
            <path d="M433.334 106.161C338.186 106.161 245.632 176.734 198.068 282.595C209.521 297.718 233.167 297.718 240.272 272.512C279.439 186.816 356.075 131.366 433.334 131.366H483.359C560.621 131.366 637.257 186.816 676.426 272.512C683.529 297.718 707.165 297.718 718.621 282.595C671.073 176.734 578.504 106.161 483.359 106.161H433.334Z" fill="var(--dark-highlight)"/>
            <path d="M969.333 536.072V482.74C982.704 492.537 996.335 500.518 1010.23 506.685C1024.29 512.672 1036.1 515.665 1045.65 515.665C1055.55 515.665 1064.06 513.126 1071.18 508.045C1078.3 502.967 1081.86 496.891 1081.86 489.815C1081.86 482.56 1079.51 476.573 1074.82 471.856C1070.31 466.958 1060.41 459.976 1045.13 450.905C1014.57 433.126 994.512 417.98 984.961 405.464C975.584 392.766 970.896 378.979 970.896 364.104C970.896 344.876 978.015 329.184 992.254 317.03C1006.67 304.876 1025.16 298.8 1047.74 298.8C1071.18 298.8 1095.23 305.693 1119.89 319.48V368.458C1091.75 350.681 1068.75 341.793 1050.86 341.793C1041.66 341.793 1034.19 343.879 1028.46 348.051C1022.9 352.041 1020.12 357.392 1020.12 364.104C1020.12 369.908 1022.64 375.442 1027.68 380.703C1032.89 385.963 1041.92 392.312 1054.77 399.75L1071.7 409.818C1111.64 433.4 1131.61 459.52 1131.61 488.182C1131.61 508.681 1123.88 525.551 1108.42 538.793C1093.14 551.854 1073.43 558.385 1049.3 558.385C1035.06 558.385 1022.38 556.843 1011.27 553.76C1000.16 550.494 986.177 544.598 969.333 536.072ZM1179.38 343.424L1268.46 251.999V303.698H1344.26V348.322H1268.46V471.041C1268.46 499.701 1279.83 514.032 1302.58 514.032C1319.6 514.032 1337.57 508.045 1356.5 496.073V542.332C1338.27 553.033 1318.38 558.385 1296.85 558.385C1275.14 558.385 1257.09 551.765 1242.67 538.522C1238.16 534.53 1234.42 530.087 1231.47 525.189C1228.52 520.11 1226 513.579 1223.92 505.597C1222.01 497.435 1221.05 482.015 1221.05 459.34V348.322H1179.38V343.424ZM1621.5 433.217H1452.98C1454.19 457.163 1461.83 476.211 1475.9 490.359C1490.14 504.508 1508.46 511.584 1530.86 511.584C1562.12 511.584 1590.94 501.425 1617.34 481.109V529.543C1602.75 539.702 1588.25 546.957 1573.84 551.311C1559.6 555.664 1542.84 557.841 1523.56 557.841C1497.17 557.841 1475.81 552.127 1459.49 540.699C1443.17 529.27 1430.06 513.941 1420.16 494.714C1410.43 475.304 1405.57 452.9 1405.57 427.504C1405.57 389.409 1415.9 358.481 1436.57 334.717C1457.23 310.771 1484.06 298.8 1517.05 298.8C1548.83 298.8 1574.18 310.409 1593.11 333.629C1612.04 356.848 1621.5 387.958 1621.5 426.959V433.217ZM1454.02 403.558H1574.62C1573.4 383.786 1567.76 368.549 1557.69 357.845C1547.62 347.142 1534.07 341.793 1517.05 341.793C1500.04 341.793 1486.06 347.142 1475.12 357.845C1464.35 368.549 1457.32 383.786 1454.02 403.558ZM1700.79 173.905H1748.2V554.031H1700.79V173.905ZM1844.67 173.905H1892.08V554.031H1844.67V173.905ZM2138.07 403.558V509.951C2138.07 518.477 2140.85 522.74 2146.41 522.74C2152.14 522.74 2161.08 518.295 2173.23 509.407V539.611C2162.47 546.866 2153.79 551.765 2147.19 554.304C2140.76 557.025 2133.99 558.385 2126.87 558.385C2106.55 558.385 2094.57 550.041 2090.92 533.353C2070.78 549.679 2049.34 557.841 2026.59 557.841C2009.92 557.841 1996.03 552.127 1984.91 540.699C1973.8 529.089 1968.24 514.576 1968.24 497.162C1968.24 481.38 1973.63 467.322 1984.39 454.986C1995.33 442.47 2010.79 432.582 2030.76 425.327L2091.45 403.558V390.226C2091.45 360.114 2077.03 345.056 2048.21 345.056C2022.33 345.056 1997.15 359.025 1972.67 386.961V332.813C1991.08 310.138 2017.56 298.8 2052.11 298.8C2077.99 298.8 2098.74 305.875 2114.37 320.024C2119.58 324.558 2124.26 330.636 2128.43 338.254C2132.6 345.692 2135.21 353.22 2136.25 360.838C2137.46 368.276 2138.07 382.516 2138.07 403.558ZM2091.45 504.508V430.225L2059.67 443.014C2043.52 449.726 2032.06 456.528 2025.29 463.421C2018.69 470.133 2015.39 478.568 2015.39 488.727C2015.39 499.068 2018.51 507.503 2024.76 514.032C2031.19 520.563 2039.44 523.829 2049.51 523.829C2064.62 523.829 2078.6 517.389 2091.45 504.508ZM2292.63 303.698V361.111L2295.24 356.757C2318.16 318.118 2341.08 298.8 2364 298.8C2381.89 298.8 2400.56 308.232 2420.01 327.097L2395 370.635C2378.5 354.309 2363.22 346.145 2349.16 346.145C2333.88 346.145 2320.59 353.764 2309.3 369.002C2298.19 384.239 2292.63 402.289 2292.63 423.15V554.031H2244.97V303.698H2292.63ZM2676.41 372.268V554.031H2628.75V414.714C2628.75 386.961 2625.19 367.642 2618.07 356.757C2610.95 345.692 2598.53 340.16 2580.82 340.16C2570.92 340.16 2561.81 342.517 2553.47 347.233C2545.31 351.95 2535.93 360.294 2525.34 372.268V554.031H2477.93V303.698H2525.34V336.621C2549.48 311.407 2573.09 298.8 2596.19 298.8C2626.58 298.8 2650.11 313.855 2666.78 343.968C2692.13 313.493 2718.61 298.255 2746.22 298.255C2769.49 298.255 2788.59 307.144 2803.53 324.922C2818.62 342.699 2826.18 369.817 2826.18 406.279V554.031H2778.77V405.735C2778.77 384.875 2774.7 368.911 2766.54 357.845C2758.38 346.78 2746.66 341.248 2731.37 341.248C2711.75 341.248 2693.43 351.587 2676.41 372.268ZM2942.72 198.393C2950.53 198.393 2957.21 201.206 2962.78 206.829C2968.33 212.453 2971.12 219.347 2971.12 227.509C2971.12 235.491 2968.33 242.384 2962.78 248.189C2957.21 253.994 2950.53 256.895 2942.72 256.895C2935.43 256.895 2928.99 253.994 2923.45 248.189C2917.88 242.202 2915.11 235.308 2915.11 227.509C2915.11 219.891 2917.88 213.178 2923.45 207.373C2928.99 201.388 2935.43 198.393 2942.72 198.393ZM2919.28 303.698H2966.69V554.031H2919.28V303.698ZM3227.53 303.698H3288.22L3189.49 426.959L3295.24 554.031H3234.55L3159.28 464.239L3088.17 554.031H3028.52L3129.32 426.959L3028.52 303.698H3088.17L3159.28 389.682L3227.53 303.698Z" fill="white"/>
            </g>
            </svg>





          </Link>
        </div>
        <div className="header-right">
          <button onClick={toggleSpotlight}>Create Playlists</button>
          {
            !isMobile &&
            <div 
              className="user-image"
              style={{ backgroundImage: `url(${userProfile.images[0]?.url})` }}>
            </div>
          }
          
        </div>
      </div>
    </>
  );
};

export default Header;
